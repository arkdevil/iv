
    Резидентные антивирусные мониторы, как большие зеленые мухи, носятся
над еще не умершим DOS, поднимая гнусное жужжание при каждой его конвульсии.
Уже и в BIOS пробралась эта мразь, поднимая писк при попытке записи в MBR 
винта ( такое я видел в Setup'ах некоторых четверок ). Хотя винт-то прийдется
когда-нибудь форматить или сами до Setup'a доберемся - все равно.
    Вот благодаря таким вот мониторам ( не путать с телевизорами ) и появились
невидимки- более продвинутое поколение - Stealth-вирусов. Идя навстречу пожела-
ниям юзеров, пообрывали они жужжалки у этих тварей, чтобы не мешать спокойно 
юзверствовать народу. И если загоралась рамочка с надписью "ктото пытается 
чтото", то это только если DOSу гдето не сидится. Посему простые юзеры этих мух
стали гонять головками по дискам, и выкидывать к еханой фене.
    Но не о стелс технологии хочу я рассказать вам, а о более простом способе 
обхода мониторов. Таком простом, что даже нерезидентным вирусам подходит.
  Нет ведь у них, нерезидентных, стелзовой защиты, и нет повести печальнее на 
свете, когда монитор антивирусный при запуске такого файла начинает кричать,
что все файлы текущего каталога, мол, открываются для записи. Так же и умереть
со страху можно, а порой за компьютером сидят люди со слабым сердцем. Это ж 
убийство, понимаешь! Good user-Dead user ! Но мы не агрессоры :-E 

    Слышали ли вы когда-нибудь об SFT ? "System File Table", или, в литератур-
ном переводе на совсем русский, -"стол, где система файлы разделывает". Ну уж
если и не стол, тут многие возразят , так таблица доступа к этому столу.
    Итак, подробнее :


 System File Table содержит такие данные, как начальный кластер файла,
   РЕЖИМ ОТКРЫТИЯ ФАЙЛА, время и дата создания,размер, указатель текущей пози-
   ции и текущицй считанный кластер. (подробнее см. НортонГад и HelpPC)
 Пользуясь этой таблицей, DOS и производит все операции с файлами.
 Поэтому необязательно пользоваться такими функциями, как 42h,43h, 5700h.

   РЕЖИМ ОТКРЫТИЯ ФАЙЛА - это то, что заносится в AL при использовании 
 функции 3Dh, и на что ругаются мониторы.

   Не нужно (!!!) открывать файл для записи, или еще круче :( - сначала для
 чтения для проверки на зараженность, а потом для записи снова( есть такие 
 "супер"-вирусы ...) 
   Файл открывается ДЛЯ ЧТЕНИЯ ! Всем молчать, особенно мониторам! Потом мы
 меняем режим открытия, как вы уже догадались, в таблице, и пишем в файл
 столько, сколько влезет !
   
   Итак, как же это реализовать:

 ; --------------------- получаем адрес элемента таблицы, относящейся к 
 ;                       данному файлу 
   mov bx,FILE_HANDLE    ; в BX - файловый номер
   mov ax,1220h          ; получить номер входа в SFT 
   int 2fh
 			 ; выход - ES:[DI] - номер входа в SFT ( байт )

   mov bl,ES:[DI]        ; помещаем номер входа в BL
   mov ax,1216h          ; получить адрес элемента SFT для данного файла
   int 2fh
			 ; выход - ES:DI - адрес элемента SFT 

 ; теперь меняем режим открытия ( он находится по адресу +2 ) :
   
   mov es:[di+2],2       ; ставим "чтение и запись"

 -D3, к примеру уже больше никогда не будет ругаться
 (правда, этот придурок вопит, когда пишешь на дискеты - используется INT 40h
  для FAT апдейт)

  Решается еще одна важная проблема - не нужно менять атрибуты файла - да-да -
спокойно пишемся в ReadOnly и Hidden файлы.  
  Так что функция 43h DOS вообще не нужна, как , собственно и эти дурацкие 
атрибуты.
   
